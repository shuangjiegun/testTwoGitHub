<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.goldfinance.jinGC.mapperOra.JYFundProductMapper">

	<sql id="query_po_where">
		<if test="innerCodes!=null  &amp;&amp;  !innerCodes.isEmpty() ">
				<foreach collection="innerCodes" item="inner_code" open=" and tsm.innercode in (" close=")" separator=",">
					#{inner_code}
				</foreach> 
		</if>
		and	tsm.SecuCategory in (8,13)
	</sql>
	
	<sql id="find_inner_where">
		<if test="secuCodes!=null  &amp;&amp; !secuCodes.isEmpty()">
				<foreach collection="secuCodes" item="secu_code" open=" and tsm.secucode in (" close=")" separator=",">
					#{secu_code}
				</foreach> 
		</if>
		and	tsm.SecuCategory in (8,13)
	</sql>
	
	<sql id="allot_tariff_where">
		<if test="chargeRateType==2">
				and  a.ChargePattern in (1,102)
		</if>
	</sql>
	
	<select id="findInnerCodeBySecuCode"  parameterType="QueryPo" resultType="MFNetValuePerformanceExtend" >
	<!-- 根据传入的基金代码查聚源数据库中对应的基金内部编码 -->
			select tsm.innercode from jydb.SecuMain tsm 
				<where>
					<include refid="find_inner_where"></include>
				</where>			
	</select>
	
	<select id="findJuYuanNoExistBySecuCode"  resultType="java.lang.Integer">
		select count(1) from jydb.SecuMain tsm where  tsm.secucode =#{secucode} and	tsm.SecuCategory in (8,13)			
	</select>
	
	
	<select id="findFundType"  parameterType="QueryPo" resultType="MFNetValuePerformanceExtend" >
			select t.innercode, t.FundTypeCode from jydb.MF_FundArchives t 
				<where>
					<include refid="find_type_where"></include>
				</where>			
	</select>
	
	<sql id="find_type_where">
		<if test="innerCodes!=null  &amp;&amp; !innerCodes.isEmpty()">
				<foreach collection="innerCodes" item="inner_code" open=" t.innercode in (" close=")" separator=",">
					#{inner_code}
				</foreach> 
		</if>
	</sql>
	
	<select id="findFundProductPageInfo"  parameterType="QueryPo" resultType="MFNetValuePerformanceExtend" >
		select tsm.secucode, tsm.chiname, tsm.secuabbr, tom.NVDailyGrowthRate, tom.RRInSelectedMonth, tom.RRSinceThisYear,temp.* from  jydb.SecuMain tsm,  jydb.MF_NetValuePerformance tom, (select * from (select tnv.innercode, tnv.UnitNV, tnv.AccumulatedUnitNV, tnv.EndDate, row_number() over(partition by innercode order by enddate desc) as num from jydb.MF_NetValue tnv where tnv.innercode in (select tsm.innercode from jydb.SecuMain tsm 
			   	<!--   where tsm.innercode in(2623,3333, 5205, 14609) -->
			   	<where>
					<include refid="query_po_where"></include>
				</where>
			  )) where num<![CDATA[<=1 ]]>) temp where tsm.innercode=temp.innercode and tom.innercode= tsm.innercode and temp.innercode = tom.innercode	
	</select>
	
	<select id="findFundProductMainInformation"  parameterType="FundOverviewExtend" resultType="FundOverviewExtend" >
		select mfa.EstablishmentDate,mfa.Manager,mfa.InvestAdvisorCode,mfa.TrusteeCode,mfa.InvestTarget,mfa.InvestField,mfa.InvestOrientation,mfa.innercode, mfa.fundtypecode, cts.ms fundTypeCodeName
		from jydb.CT_SystemConst cts, jydb.MF_FundArchives mfa		
		where cts.lb=1249 and cts.dm=mfa.fundtypecode and mfa.innercode=#{innercode}							
	</select>
	
	<select id="findRecordExist"  parameterType="java.lang.Integer" resultType="java.lang.Integer" >
		select count(1) from jydb.MF_FundArchivesAttach where innercode =#{innercode} and TypeCode=10 and DataCode=1106							
	</select>
	
	<select id="findFundProductRiskInformation"  parameterType="FundOverviewExtend" resultType="FundOverviewExtend" >
		select temp.riskevaluation, cts.ms RiskEvaluationName
		from jydb.CT_SystemConst cts, 
 		     ( select * from (select mff.FundInnerCode, mff.RiskEvaluation, row_number() over(partition by FundInnerCode order by enddate desc) as num 
 		     from jydb.MF_FundRating mff) where num<![CDATA[<=1 ]]>) temp
		where cts.lb=1365 and temp.RiskEvaluation=cts.dm and temp.FundInnerCode=#{innercode}								
	</select>
	
	<select id="findFundProductNetAssetsValueAndEndShares"  parameterType="FundOverviewExtend" resultType="FundOverviewExtend" >
		select EndShares lastestShares, NetAssetsValue lastestAssetsValue from (
		select mfc.EndShares, mfi.NetAssetsValue
		from jydb.MF_SharesChange mfc, jydb.MF_MainFinancialIndexQ mfi
		where mfc.innercode=mfi.innercode and mfi.innercode=#{innercode} order by mfc.EndDate desc ,mfi.EndDate desc ) where rownum=1							
	</select>
	
	<select id="findFundProductInvestAdvisorNameAndTrusteeName"  parameterType="FundOverviewExtend" resultType="FundOverviewExtend" >
		select miao.InvestAdvisorName investAdvisorCodeName, mto.TrusteeName trusteeCodeName
		from jydb.MF_InvestAdvisorOutline miao, jydb.MF_TrusteeOutline mto
		where miao.investadvisorcode=#{investAdvisorCode}  and mto.TrusteeCode=#{trusteeCode} 							
	</select>
	
	<select id="findSingleFundEarningsTrend"  parameterType="EarningsTrend" resultType="EarningsTrend" >
		select enddate, UnitNV, AccumulatedUnitNV, NVDailyGrowthRate
		from(select t.UnitNV, t.AccumulatedUnitNV,row_number() over (order by t.enddate desc) rn , m.NVDailyGrowthRate, t.enddate
		from jydb.MF_NetValue t, jydb.MF_NetValuePerformanceHis m
		where t.enddate=m.TradingDay and t.innercode= m.innercode and t.innercode=#{innerCode})
		where rn between ( (#{pageNumber}-1)*#{pageSize} + 1 ) and (#{pageNumber}*#{pageSize})	
	</select>
	
	<select id="findHuoBiSingleFundEarningsTrend"  parameterType="EarningsTrend" resultType="EarningsTrend" >
    	select enddate, UnitNV, AccumulatedUnitNV, NVDailyGrowthRate
		from(select t.DailyProfit as UnitNV, t.DailyProfit as AccumulatedUnitNV,row_number() over (order by t.enddate desc) rn , m.AnnualizedRRInSingleWeek as NVDailyGrowthRate, t.enddate
		from jydb.MF_NetValue t, jydb.MF_MMYieldPerformance m
		where t.enddate=m.TradingDay and t.innercode= m.innercode and t.innercode=#{innerCode})
		where rn between ( (#{pageNumber}-1)*#{pageSize} + 1 ) and (#{pageNumber}*#{pageSize})	
	</select>
	
	<!--   <select id="findSingleFundProductTariffStructure"  parameterType="TariffStructure" resultType="TariffStructure" >
		select MinimumChargeRate,MaximumChargeRate,ChargeRateDesciption,IntervalDescription,ExcuteDate
		from jydb.MF_ChargeRate
		where IfExecuted=1 and ChargeRateType=#{chargeRateType} and innercode=#{innerCode}  order by ExcuteDate desc
	</select> -->
	
	<select id="findSingleFundProductTariffStructure"  parameterType="TariffStructure" resultType="TariffStructure" >
		select a.MinimumChargeRate, a.MaximumChargeRate, a.ChargeRateDesciption, a.IntervalDescription, a.ExcuteDate 
		from jydb.MF_ChargeRate a
		join jydb.MF_ChargeRate_SE b on a.ID=b.ID and b.typecode=3
		join jydb.CT_SystemConst c on c.dm=b.code and c.lb=1807	
		<where>
			a.innercode=#{innerCode} and a.chargeratetype=#{chargeRateType} and a.IfExecuted=1 
			<include refid="allot_tariff_where"></include>
			and c.dm=10 order by ExcuteDate desc
		</where>
	</select>
	
	
		<select id="findHuoBiFundProductPageInfo"  parameterType="QueryPo" resultType="MFNetValuePerformanceExtend" >
		select tsm.secucode, tsm.chiname, tsm.secuabbr, temp1.innercode, temp1.UnitNV,temp1.AccumulatedUnitNV,temp1.EndDate ,temp2.NVDailyGrowthRate,temp2.RRInSelectedMonth, temp2.RRSinceThisYear
		from jydb.SecuMain tsm, 
		(select * from (select tnv.innercode, tnv.DailyProfit as UnitNV, tnv.DailyProfit as AccumulatedUnitNV, tnv.EndDate, row_number() over(partition by innercode order by enddate desc) as num 
		from jydb.MF_NetValue tnv 
		where tnv.innercode in (select tsm.innercode from jydb.SecuMain tsm 
					   	<where>
							<include refid="query_hb_where"></include>
						</where>												
		and tsm.SecuCategory in (8,13) )) where num <![CDATA[<=1 ]]> ) temp1,
		(select * from (select tom.innercode,tom.AnnualizedRRInSingleWeek as NVDailyGrowthRate, tom.AnnualizedRRInTwoWeek as RRInSelectedMonth, tom.RRSinceThisYear as RRSinceThisYear, row_number() over(partition by innercode order by TradingDay desc) as num 
		from jydb.MF_MMYieldPerformance tom 
		where tom.innercode in (select tsm.innercode from jydb.SecuMain tsm 
					   	<where>
							<include refid="query_hb_where"></include>
						</where>
		and tsm.SecuCategory in (8,13) )) where num <![CDATA[<=1 ]]> ) temp2 
		where tsm.innercode=temp1.innercode and tsm.innercode= temp2.innercode and temp1.innercode = temp2.innercode 
	</select>

	<sql id="query_hb_where">
		<if test="innerCodes!=null  &amp;&amp;  !innerCodes.isEmpty() ">
				<foreach collection="innerCodes" item="inner_code" open=" tsm.innercode in (" close=")" separator=",">
					#{inner_code}
				</foreach> 
		</if>
	</sql>
	
</mapper>